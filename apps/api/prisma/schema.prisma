// PR4Y - Prisma schema
// Postgres database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String        @map("password_hash")
  createdAt    DateTime      @default(now()) @map("created_at")
  refreshTokens RefreshToken[]
  wrappedDek   WrappedDek?
  records      Record[]
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model WrappedDek {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  kdfName       String   @map("kdf_name")
  kdfParams     Json     @map("kdf_params_json")
  saltB64       String   @map("salt_b64")
  wrappedDekB64 String   @map("wrapped_dek_b64")
  updatedAt     DateTime @updatedAt @map("updated_at")
  @@map("wrapped_dek")
}

// Record: sync gen√©rico (oraciones, diario, etc.). Conflictos por version, no por timestamp.
// type = metadato no sensible (p. ej. "prayer_request", "journal_entry"); contenido en encryptedPayloadB64.
model Record {
  id                  String   @id @default(uuid()) @map("record_id")
  userId              String   @map("user_id")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                String   // metadato: tipo de registro; no cifrado
  version             Int
  encryptedPayloadB64 String   @map("encrypted_payload_b64")
  clientUpdatedAt     DateTime @map("client_updated_at")
  serverUpdatedAt     DateTime @updatedAt @map("server_updated_at")
  deleted             Boolean  @default(false)
  @@index([userId])
  @@index([userId, clientUpdatedAt]) // Pull ordenado por clientUpdatedAt
  @@map("records")
}
