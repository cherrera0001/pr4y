# Análisis logcat 20260218-204604 y plan de mitigación

**Archivo:** `logcat-login-20260218-204604.txt`  
**App:** com.pr4y.app (prod)  
**Dispositivo:** captura durante apertura de app y flujo de login con Google.

---

## 1. Hallazgos críticos (evidencia del log)

| Orden | Línea(s) | Tag / mensaje | Interpretación |
|-------|----------|----------------|----------------|
| 1 | 310 | `PR4Y_ERROR: Login: NoCredentialException (useNonce=false)` | Credential Manager no devolvió credenciales en el primer intento (sin nonce). |
| 2 | 311 | `PR4Y_APP: Login: Intento sin nonce falló... intentando con nonce` | Reintento automático con nonce. |
| 3 | 326 | `PR4Y_ERROR: Login: NoCredentialException (useNonce=true)` | Tampoco con nonce. Se dispara el fallback legacy (Google Sign-In). |
| 4 | 545-546 | `PR4Y_ERROR: Login: legacy failed` + `ApiException: 10` | Tras elegir cuenta en el flujo legacy, Google devuelve **código 10 (DEVELOPER_ERROR)**. |

**Conclusión:** La causa raíz es la misma para Credential Manager y para el flujo legacy: **Google no reconoce la app** (com.pr4y.app) con el certificado con el que está firmado el APK instalado. El código 10 indica **configuración incorrecta en GCP** (cliente Android: package + SHA-1).

---

## 2. Razonamiento

- **NoCredentialException** y **ApiException 10** suelen deberse a:
  - La **huella SHA-1** del certificado del APK **no está registrada** en el cliente OAuth de tipo **Android** en Google Cloud, o
  - El **nombre del paquete** en ese cliente no coincide (`com.pr4y.app` para prod), o
  - Se usa un Web Client ID que no está asociado a un cliente Android con esa SHA-1 y package.
- No es un fallo de red ni de backend: el fallo ocurre **antes** de enviar el token al búnker (en la obtención del token por parte de Google).

---

## 3. Acciones de mitigación aplicadas (código y documentación)

1. **LoginViewModel (`handleLegacySignInResult`):**
   - Se detecta **ApiException** y, si **statusCode == 10**, se muestra al usuario un mensaje claro: *"Google no reconoce esta instalación. Si eres el desarrollador, añade la huella SHA-1 del APK en Google Cloud (cliente Android)."*
   - Se registra en log la referencia a `COMO-RESOLVER-LOGIN.md` para depuración.

2. **COMO-RESOLVER-LOGIN.md:**
   - Añadida fila en la tabla "Otros fallos posibles" para **ApiException 10** / **Login: legacy failed**, con la acción: registrar SHA-1 y package en el cliente Android de GCP (sección 2).

3. **Este documento:** deja constancia del análisis y del plan para futuras capturas.

---

## 4. Acción requerida (configuración en GCP)

**Quién tiene acceso a Google Cloud Console debe:**

1. Obtener la **SHA-1** del certificado con el que se firmó el APK instalado en el dispositivo:
   - Build **prodDebug** / **prodRelease**: si se firma con el keystore de release (local.properties), usar la SHA-1 de ese keystore; si no, la del `debug.keystore`.
   - Comando (ejemplo):  
     `.\gradlew :app:showDebugSha1` (desde `apps/mobile-android`) para debug, o `keytool -list -v -keystore <ruta> -alias <alias>` para release.

2. En **Google Cloud Console → APIs y servicios → Credenciales**:
   - Abrir (o crear) el **cliente OAuth 2.0 de tipo Android** del mismo proyecto que el Web Client ID que usa la app.
   - **Nombre del paquete:** `com.pr4y.app`
   - **Huella digital del certificado SHA-1:** pegar la SHA-1 del paso 1.
   - Guardar. Los cambios pueden tardar unos minutos.

3. Reinstalar la app y repetir el flujo de login; capturar un nuevo logcat si el problema persiste.

---

## 5. Seguimiento: logcat 20260218-205045 (nuevo mensaje en log)

**Archivo:** `logcat-login-20260218-205045.txt`

Tras desplegar el manejo explícito de ApiException 10, en esta captura aparece el **nuevo mensaje** que añadimos en código:

| Línea | Tag / mensaje | Interpretación |
|-------|----------------|----------------|
| 724 | `PR4Y_ERROR: Login: legacy ApiException 10 (DEVELOPER_ERROR). Registrar SHA-1 y package en GCP. Ver COMO-RESOLVER-LOGIN.md` | Mensaje de log **intencional**: identifica el error 10 y apunta a la documentación. |
| 725 | `ApiException: 10` | Mismo fallo de configuración (SHA-1/package en GCP). |

**Flujo registrado en 205045:** NoCredentialException (sin nonce) → reintento con nonce → NoCredentialException (con nonce) → se abre SignInHubActivity (legacy) → usuario elige cuenta → **ApiException 10** → la app muestra al usuario *"Google no reconoce esta instalación. Si eres el desarrollador, añade la huella SHA-1 del APK en Google Cloud (cliente Android)."*

**Conclusión:** No hay un bug nuevo. El "nuevo mensaje" es el log y el texto de usuario que implementamos para ApiException 10. La causa sigue siendo la misma: **registrar la SHA-1 y el package en el cliente Android de GCP**.

**Nota:** En la captura `logcat-login-20260218-205146.txt` no hay líneas PR4Y_* (no se reprodujo login durante esa ventana de 20 s).

---

## 6. Análisis del log completo 205045 (líneas 1–1185)

**Archivo:** `logcat-login-20260218-205045.txt` (completo).

### Cronología del flujo de la app (com.pr4y.app, PID 31073)

| Aprox. línea | Timestamp     | Evento |
|---------------|---------------|--------|
| 35-46         | 20:51:48      | Apertura de la app (PreLaunchProcess, MainActivity, Zygote). |
| 137           | 20:51:50      | `Pr4yApp.onCreate` (hypothesisId=H1,H5). |
| 197-272       | 20:51:51-52   | Búnker PR4Y: inicio async, almacén cifrado en TEE, "Almacén cifrado listo". |
| 418           | 20:51:54      | `RTMode: pkgName: com.pr4y.app has no permission` (mensaje del sistema Xiaomi; no es la causa del 10). |
| 472-473       | 20:51:55      | **NoCredentialException** (useNonce=false) → "Intento sin nonce falló... intentando con nonce". |
| 480           | 20:51:56      | **NoCredentialException** (useNonce=true) → se lanza flujo legacy. |
| 487-611       | 20:51:56      | SignInHubActivity → SignInActivity → AccountPickerActivity (usuario elige cuenta). |
| 723-766       | 20:51:59      | Vuelta a la app → **ApiException 10** → log "Registrar SHA-1 y package en GCP" + mensaje al usuario. |
| 1124          | 20:52:04      | Segundo intento de login: de nuevo `RTMode: com.pr4y.app has no permission`. |
| 1133-1160     | 20:52:04-05   | Segunda ronda: NoCredentialException (sin nonce y con nonce). |
| 1163-1185     | 20:52:05      | SignInHubActivity visible de nuevo; el log termina antes del resultado del segundo legacy. |

### SHA-1 extraída de este log

En las líneas **141-142** (y 861-862) el subsistema de cuentas Xiaomi registra la firma de la app en Base64. Decodificado:

- **SHA-1:** `7B6DC7079C34739CE81159719FB5EB61D2A03225`
- **Formato para Google Cloud Console** (con dos puntos):  
  `7B:6D:C7:07:9C:34:73:9C:E8:11:59:71:9F:B5:EB:61:D2:A0:32:25`

Esa es la huella del certificado con el que estaba firmado el APK en el momento de la captura. Debe coincidir con la que añades en el **cliente OAuth de tipo Android** en GCP (package `com.pr4y.app`).

### Otros mensajes del log (no críticos para el login)

- **LB / FrameInsert** (ej. 163, 531): fallos al abrir nodos del sistema; típicos en algunos dispositivos, no afectan al flujo de Google.
- **jccc / ManagedChannel** (538-591): avisos internos de Google Play Services; no son de la app.
- **RTMode "has no permission"**: permiso opcional del sistema; el fallo de login se debe al **DEVELOPER_ERROR** (SHA-1/package en GCP), no a este mensaje.

---

## 7. Referencias

- `COMO-RESOLVER-LOGIN.md` – pasos detallados para NoCredentialException y ApiException 10.
- `PROMPT-EVALUAR-LOGCAT-LOGIN.md` – prompt reutilizable para evaluar futuros logcats.
